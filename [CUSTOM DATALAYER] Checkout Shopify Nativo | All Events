// === customPixelEvents.js ===
const customPixelEvents = (() => {
  const GTM_ID = 'GTM-XXXXXXX'; // Insira seu ID real

  const loadGTM = () => {
    if (window.gtmHasLoaded) return;
    (function(w,d,s,l,i){
      w[l]=w[l]||[];
      w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0],
          j=d.createElement(s),
          dl=l != 'dataLayer' ? '&l=' + l : '';
      j.async = true;
      j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window,document,'script','dataLayer', GTM_ID);
    window.gtmHasLoaded = true;
    window.dataLayer = window.dataLayer || [];
  };

  const mapItems = (lineItems) => {
    return lineItems.map(lineItem => ({
      item_id: lineItem.variant.product.id,
      item_name: lineItem.title,
      item_brand: lineItem.variant.product.vendor,
      item_category: lineItem.variant.product.type,
      item_sku: lineItem.variant.sku,
      item_variant: lineItem.variant.id,
      variant_name: lineItem.variant.title,
      imageURL: lineItem.variant.image?.url ? 'https:' + lineItem.variant.image.url : null,
      price: parseFloat(lineItem.variant.price.amount),
      quantity: parseInt(lineItem.quantity, 10)
    }));
  };

  const pushEvent = (eventName, checkout, extraData = {}) => {
    const shipping = checkout.shippingAddress;

    window.dataLayer.push({
      event: eventName,
      debug_mode: true,
      fired_from: 'custom_pixel',
      token: checkout.token,
      user_data: {
        email: checkout.email,
        phone: shipping.phone,
        first_name: shipping.firstName,
        last_name: shipping.lastName,
        address: shipping.address1,
        city: shipping.city,
        region: shipping.provinceCode,
        country: shipping.countryCode,
        zip: shipping.zip
      },
      ecommerce: {
        quantity: checkout.lineItems.length,
        value: parseFloat(checkout.totalPrice.amount),
        currency: checkout.currencyCode,
        items: mapItems(checkout.lineItems)
      },
      ...extraData
    });
  };

  return {
    beginCheckout: (event) => {
      loadGTM();
      console.log('checkout_started', event);
      pushEvent('begin_checkout_e2no', event.data.checkout);
    },

    addShippingInfo: (event) => {
      loadGTM();
      console.log('checkout_address_info_submitted', event);
      pushEvent('add_shipping_info_e2no', event.data.checkout);
    },

    addPaymentInfo: (event) => {
      loadGTM();
      console.log('payment_info_submitted', event);
      pushEvent('add_payment_info_e2no', event.data.checkout);
    },

    purchase: (event) => {
      loadGTM();
      console.log('checkout_completed', event);

      const checkout = event.data.checkout;
      const order = checkout.order;

      pushEvent('purchase_e2no', checkout, {
        transaction_id: order.id,
        shipping: parseFloat(checkout.shippingLine?.price?.amount || 0),
        tax: parseFloat(checkout.totalTax || 0),
        new_customer: order.customer?.isFirstOrder || false,
        coupon: checkout.discountApplications?.[0]?.title || null
      });
    }
  };
})();

// === Registros dos eventos do Shopify Pixel ===
analytics.subscribe('checkout_started', customPixelEvents.beginCheckout);
analytics.subscribe('checkout_address_info_submitted', customPixelEvents.addShippingInfo);
analytics.subscribe('payment_info_submitted', customPixelEvents.addPaymentInfo);
analytics.subscribe('checkout_completed', customPixelEvents.purchase);
